<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyALblbqW_VrZh2r7sPJ8Q6XT2fGbk0dsFg",
        authDomain: "donghung-3208d.firebaseapp.com",
        projectId: "donghung-3208d",
        storageBucket: "donghung-3208d.firebasestorage.app",
        messagingSenderId: "753379492663",
        appId: "1:753379492663:web:baff34f2c0bac00e02d0b2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // H√†m t·∫£i d·ªØ li·ªáu (ch·ªâ g·ªçi khi ƒë√£ ch·∫Øc ch·∫Øn ƒëƒÉng nh·∫≠p)
    async function loadUsers() {
        const userList = document.getElementById('userList');
        try {
            console.log("üöÄ Auth OK, b·∫Øt ƒë·∫ßu l·∫•y d·ªØ li·ªáu Firestore...");
            const snapshot = await getDocs(collection(db, "users"));
            userList.innerHTML = '';

            snapshot.forEach((userDoc) => {
                const data = userDoc.data();
                const uid = userDoc.id;
                
                let deviceHtml = "";
                if (data.devices) {
                    Object.keys(data.devices).forEach(key => {
                        deviceHtml += `<span class="device-tag">üíª ${data.devices[key].name || 'Thi·∫øt b·ªã'}</span>`;
                    });
                }

                const dobokuProgress = data.exam_progress?.doboku || 0;
                const kenchikuProgress = data.exam_progress?.kenchiku || 0;

                const row = `
                    <tr>
                        <td><strong>${data.name || 'H·ªçc vi√™n'}</strong><br><small>${data.email}</small></td>
                        <td><b>${data.device_count || 0} / 1</b>${deviceHtml}</td>
                        <td>
                            <span class="progress-badge">Th·ªï m·ªôc: ${dobokuProgress}%</span>
                            <span class="progress-badge">Ki·∫øn tr√∫c: ${kenchikuProgress}%</span>
                        </td>
                        <td class="${data.status === 'banned' ? 'status-banned' : 'status-active'}">
                            ${data.status === 'banned' ? 'ƒê√£ kh√≥a' : 'Ho·∫°t ƒë·ªông'}
                        </td>
                        <td>
                            <button class="btn btn-reset" onclick="resetDevice('${uid}')">Reset M√°y</button>
                            ${data.status === 'banned' 
                                ? `<button class="btn btn-unban" onclick="toggleStatus('${uid}', 'active')">M·ªü kh√≥a</button>`
                                : `<button class="btn btn-ban" onclick="toggleStatus('${uid}', 'banned')">Kh√≥a</button>`
                            }
                        </td>
                    </tr>`;
                userList.innerHTML += row;
            });

            document.getElementById('loading').style.display = 'none';
            document.getElementById('adminTable').style.display = 'table';
        } catch (error) {
            console.error("L·ªói Firestore:", error);
            document.getElementById('loading').innerHTML = `‚ùå L·ªói quy·ªÅn truy c·∫≠p. <br><small>${error.message}</small>`;
        }
    }

    // --- QUAN TR·ªåNG: Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ch·∫°y ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("‚úÖ Admin ƒë√£ ƒëƒÉng nh·∫≠p:", user.email);
            loadUsers();
        } else {
            console.warn("‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p Admin, chuy·ªÉn h∆∞·ªõng...");
            alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi v√†o trang qu·∫£n tr·ªã!");
            window.location.href = "login.html";
        }
    });

    // C√°c h√†m global cho button
    window.resetDevice = async (uid) => {
        if (!confirm("Reset thi·∫øt b·ªã cho h·ªçc vi√™n n√†y?")) return;
        await updateDoc(doc(db, "users", uid), { device_count: 0, devices: {} });
        location.reload();
    };

    window.toggleStatus = async (uid, nextStatus) => {
        if (!confirm("X√°c nh·∫≠n thay ƒë·ªïi tr·∫°ng th√°i?")) return;
        await updateDoc(doc(db, "users", uid), { status: nextStatus });
        location.reload();
    };
</script>
