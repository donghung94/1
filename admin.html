<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã Vi√™n - Toukutei 2</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        /* Ph·∫ßn th√¥ng tin m√°y Admin */
        .admin-info { background: #eff6ff; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2563eb; font-size: 13px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #1e40af; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; color: white; }
        .btn-reset { background: #f59e0b; }
        .btn-ban { background: #ef4444; }
        .btn-unban { background: #10b981; }
        
        .status-active { color: #059669; font-weight: bold; }
        .status-banned { color: #dc2626; font-weight: bold; }
        .device-id { font-family: monospace; font-size: 11px; background: #eee; padding: 2px 4px; display: block; margin-top: 4px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Qu·∫£n L√Ω H·ªçc Vi√™n</h2>
        <button class="btn" style="background:#64748b" onclick="location.reload()">L√†m m·ªõi trang</button>
    </div>

    <div class="admin-info" id="current-admin-device">
        ƒêang ki·ªÉm tra thi·∫øt b·ªã qu·∫£n tr·ªã...
    </div>

    <div id="loading" style="text-align:center; padding: 20px;">üöÄ ƒêang t·∫£i danh s√°ch h·ªçc vi√™n...</div>

    <table id="adminTable" style="display:none;">
        <thead>
            <tr>
                <th>H·ªçc vi√™n</th>
                <th>Thi·∫øt b·ªã (ID)</th>
                <th>Ti·∫øn ƒë·ªô</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="userList"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyALblbqW_VrZh2r7sPJ8Q6XT2fGbk0dsFg",
        authDomain: "donghung-3208d.firebaseapp.com",
        projectId: "donghung-3208d",
        storageBucket: "donghung-3208d.firebasestorage.app",
        messagingSenderId: "753379492663",
        appId: "1:753379492663:web:baff34f2c0bac00e02d0b2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // 1. Nh·∫≠n di·ªán m√°y Admin ƒëang d√πng
    const myDeviceId = localStorage.getItem('my_device_id') || "Ch∆∞a x√°c ƒë·ªãnh";
    document.getElementById('current-admin-device').innerHTML = `
        <strong>M√°y c·ªßa b·∫°n:</strong> ${navigator.platform} | <strong>ID:</strong> ${myDeviceId}
    `;

    // 2. Ch·ªâ t·∫£i d·ªØ li·ªáu sau khi Auth th√†nh c√¥ng
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!");
            window.location.href = "login.html";
            return;
        }

        try {
            const querySnapshot = await getDocs(collection(db, "users"));
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            querySnapshot.forEach((userDoc) => {
                const data = userDoc.data();
                const uid = userDoc.id;

                // L·∫•y ID thi·∫øt b·ªã c·ªßa h·ªçc vi√™n (n·∫øu c√≥)
                let deviceIdText = "Ch∆∞a ƒëƒÉng nh·∫≠p m√°y n√†o";
                if (data.devices) {
                    const ids = Object.keys(data.devices);
                    if (ids.length > 0) deviceIdText = ids[0]; // L·∫•y ID ƒë·∫ßu ti√™n
                }

                const row = `
                    <tr>
                        <td>
                            <strong>${data.name || 'N/A'}</strong><br>
                            <small>${data.email}</small>
                        </td>
                        <td>
                            <b>${data.device_count || 0} / 1</b>
                            <span class="device-id">${deviceIdText}</span>
                        </td>
                        <td>
                            T: ${data.exam_progress?.doboku || 0}% | K: ${data.exam_progress?.kenchiku || 0}%
                        </td>
                        <td class="${data.status === 'banned' ? 'status-banned' : 'status-active'}">
                            ${data.status === 'banned' ? 'Kh√≥a' : 'M·ªü'}
                        </td>
                        <td>
                            <button class="btn btn-reset" onclick="resetDevice('${uid}')">Reset M√°y</button>
                            <button class="btn ${data.status === 'banned' ? 'btn-unban' : 'btn-ban'}" 
                                onclick="toggleStatus('${uid}', '${data.status === 'banned' ? 'active' : 'banned'}')">
                                ${data.status === 'banned' ? 'M·ªü' : 'Kh√≥a'}
                            </button>
                        </td>
                    </tr>
                `;
                userList.innerHTML += row;
            });

            document.getElementById('loading').style.display = 'none';
            document.getElementById('adminTable').style.display = 'table';

        } catch (error) {
            console.error("L·ªói:", error);
            document.getElementById('loading').innerHTML = "‚ùå L·ªói t·∫£i d·ªØ li·ªáu. Ki·ªÉm tra l·∫°i Rules.";
        }
    });

    // H√†m Reset m√°y
    window.resetDevice = async (uid) => {
        if (confirm("Reset thi·∫øt b·ªã cho h·ªçc vi√™n n√†y?")) {
            await updateDoc(doc(db, "users", uid), { device_count: 0, devices: {} });
            location.reload();
        }
    };

    // H√†m Kh√≥a/M·ªü
    window.toggleStatus = async (uid, newStatus) => {
        if (confirm("X√°c nh·∫≠n thay ƒë·ªïi tr·∫°ng th√°i h·ªçc vi√™n?")) {
            await updateDoc(doc(db, "users", uid), { status: newStatus });
            location.reload();
        }
    };
</script>

</body>
</html>
