<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã Vi√™n - Toukutei 2</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: #1e3a8a; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; margin-top: 0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
        th { background: #1e40af; color: white; padding: 12px; text-align: left; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: top; }
        tr:hover { background-color: #f8fafc; }

        .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; font-size: 12px; }
        .btn-reset { background: #f59e0b; margin-right: 5px; }
        .btn-reset:hover { background: #d97706; }
        .btn-ban { background: #ef4444; }
        .btn-unban { background: #10b981; }

        .progress-badge { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; display: inline-block; margin: 2px; }
        .device-tag { font-size: 11px; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; color: #475569; display: block; margin-top: 4px; }
        .status-active { color: #059669; font-weight: bold; }
        .status-banned { color: #dc2626; font-weight: bold; }
        
        #loading { text-align: center; padding: 50px; font-size: 18px; color: #64748b; }
    </style>
</head>
<body>

<div class="container">
    <h2>Qu·∫£n L√Ω H·ªçc Vi√™n & Thi·∫øt B·ªã</h2>
    <div id="loading">üöÄ ƒêang t·∫£i d·ªØ li·ªáu h·ªçc vi√™n...</div>
    
    <table id="adminTable" style="display:none;">
        <thead>
            <tr>
                <th>H·ªçc vi√™n / Email</th>
                <th>Thi·∫øt b·ªã (Max: 1)</th>
                <th>Ti·∫øn ƒë·ªô h·ªçc</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="userList"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

   const firebaseConfig = {
  apiKey: "AIzaSyALblbqW_VrZh2r7sPJ8Q6XT2fGbk0dsFg",
  authDomain: "donghung-3208d.firebaseapp.com",
  projectId: "donghung-3208d",
  storageBucket: "donghung-3208d.firebasestorage.app",
  messagingSenderId: "753379492663",
  appId: "1:753379492663:web:baff34f2c0bac00e02d0b2",
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadUsers() {
        try {
            const snapshot = await getDocs(collection(db, "users"));
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            snapshot.forEach((userDoc) => {
                const data = userDoc.data();
                const uid = userDoc.id;
                
                // Hi·ªÉn th·ªã thi·∫øt b·ªã
                let deviceHtml = "";
                if (data.devices) {
                    Object.keys(data.devices).forEach(key => {
                        deviceHtml += `<span class="device-tag">üíª ${data.devices[key].name || 'Thi·∫øt b·ªã'}</span>`;
                    });
                }

                // Hi·ªÉn th·ªã ti·∫øn ƒë·ªô (N·∫øu kh√¥ng c√≥ th√¨ hi·ªán 0)
                const dobokuProgress = data.exam_progress?.doboku || 0;
                const kenchikuProgress = data.exam_progress?.kenchiku || 0;

                const row = `
                    <tr>
                        <td>
                            <strong>${data.name || 'H·ªçc vi√™n'}</strong><br>
                            <small style="color:#64748b">${data.email}</small>
                        </td>
                        <td>
                            <b>${data.device_count || 0} / 1</b>
                            ${deviceHtml}
                        </td>
                        <td>
                            <span class="progress-badge">Th·ªï m·ªôc: ${dobokuProgress}%</span>
                            <span class="progress-badge">Ki·∫øn tr√∫c: ${kenchikuProgress}%</span>
                        </td>
                        <td class="${data.status === 'banned' ? 'status-banned' : 'status-active'}">
                            ${data.status === 'banned' ? 'ƒê√£ kh√≥a' : 'Ho·∫°t ƒë·ªông'}
                        </td>
                        <td>
                            <button class="btn btn-reset" onclick="resetDevice('${uid}')">Reset M√°y</button>
                            ${data.status === 'banned' 
                                ? `<button class="btn btn-unban" onclick="toggleStatus('${uid}', 'active')">M·ªü kh√≥a</button>`
                                : `<button class="btn btn-ban" onclick="toggleStatus('${uid}', 'banned')">Kh√≥a</button>`
                            }
                        </td>
                    </tr>
                `;
                userList.innerHTML += row;
            });

            document.getElementById('loading').style.display = 'none';
            document.getElementById('adminTable').style.display = 'table';
        } catch (error) {
            console.error(error);
            alert("L·ªói t·∫£i d·ªØ li·ªáu. H√£y ki·ªÉm tra Rules Firestore!");
        }
    }

    // --- H√ÄM RESET THI·∫æT B·ªä ---
    window.resetDevice = async (uid) => {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën Reset thi·∫øt b·ªã cho h·ªçc vi√™n n√†y kh√¥ng? H·ªç s·∫Ω c√≥ th·ªÉ ƒëƒÉng nh·∫≠p ·ªü m√°y m·ªõi.")) return;
        try {
            const userRef = doc(db, "users", uid);
            await updateDoc(userRef, {
                device_count: 0,
                devices: {}
            });
            alert("ƒê√£ Reset th√†nh c√¥ng!");
            loadUsers();
        } catch (e) { alert("L·ªói: " + e.message); }
    };

    // --- H√ÄM KH√ìA / M·ªû KH√ìA ---
    window.toggleStatus = async (uid, nextStatus) => {
        const action = nextStatus === 'banned' ? "Kh√≥a" : "M·ªü kh√≥a";
        if (!confirm(`X√°c nh·∫≠n ${action} h·ªçc vi√™n n√†y?`)) return;
        try {
            await updateDoc(doc(db, "users", uid), { status: nextStatus });
            loadUsers();
        } catch (e) { alert("L·ªói: " + e.message); }
    };

    // Kh·ªüi ƒë·ªông
    loadUsers();

</script>
</body>
</html>
