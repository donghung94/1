<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản Lý Học Viên</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1e40af; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8fafc; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; color: white; }
        .btn-reset { background-color: #f59e0b; margin-right: 5px; }
        .btn-ban { background-color: #ef4444; }
        .btn-unban { background-color: #10b981; }
        .status-active { color: green; font-weight: bold; }
        .status-banned { color: red; font-weight: bold; }
        .device-info { font-size: 11px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>Quản Lý Học Viên Toukutei 2</h2>
    <div id="loading">Đang tải dữ liệu...</div>
    <table id="userTable" style="display:none;">
        <thead>
            <tr>
                <th>Học viên</th>
                <th>Thiết bị (Count)</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="userList"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. CẤU HÌNH FIREBASE (Thay bằng của bạn)
    const firebaseConfig = {
        apiKey: "AIzaSyALblbqW_VrZh2r7sPJ8Q6XT2fGbk0dsFg",
        authDomain: "donghung-3208d.firebaseapp.com",
        projectId: "donghung-3208d",
        storageBucket: "donghung-3208d.firebasestorage.app",
        messagingSenderId: "753379492663",
        appId: "1:753379492663:web:baff34f2c0bac00e02d0b2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const userList = document.getElementById('userList');
    const loading = document.getElementById('loading');
    const userTable = document.getElementById('userTable');

    // 2. LẤY DANH SÁCH USER
    async function fetchUsers() {
        try {
            const querySnapshot = await getDocs(collection(db, "users"));
            userList.innerHTML = '';
            querySnapshot.forEach((document) => {
                const data = document.data();
                const id = document.id;
                
                // Hiển thị danh sách thiết bị
                let deviceHtml = '';
                if(data.devices) {
                    Object.values(data.devices).forEach(dev => {
                        deviceHtml += `<div class="device-info">• ${dev.name} (${new Date(dev.last_login?.seconds * 1000).toLocaleDateString()})</div>`;
                    });
                }

                const row = `
                    <tr>
                        <td>
                            <strong>${data.name || 'N/A'}</strong><br>
                            <span style="font-size:12px; color:blue">${data.email}</span>
                        </td>
                        <td>
                            <b>${data.device_count || 0} / 2</b>
                            ${deviceHtml}
                        </td>
                        <td class="${data.status === 'banned' ? 'status-banned' : 'status-active'}">
                            ${data.status === 'banned' ? 'Đã khóa' : 'Hoạt động'}
                        </td>
                        <td>
                            <button class="btn btn-reset" onclick="resetDevice('${id}')">Reset Máy</button>
                            ${data.status === 'banned' 
                                ? `<button class="btn btn-unban" onclick="toggleBan('${id}', 'active')">Mở khóa</button>` 
                                : `<button class="btn btn-ban" onclick="toggleBan('${id}', 'banned')">Khóa</button>`}
                        </td>
                    </tr>
                `;
                userList.innerHTML += row;
            });
            loading.style.display = 'none';
            userTable.style.display = 'table';
        } catch (error) {
            console.error(error);
            alert("Lỗi tải dữ liệu. Kiểm tra Rules Firestore.");
        }
    }

    // 3. HÀM RESET THIẾT BỊ (Xóa hết máy cũ để họ đăng nhập máy mới)
    window.resetDevice = async (uid) => {
        if (!confirm("Xác nhận reset toàn bộ thiết bị cho học viên này?")) return;
        const userRef = doc(db, "users", uid);
        await updateDoc(userRef, {
            devices: {},
            device_count: 0
        });
        alert("Đã Reset thành công!");
        fetchUsers();
    };

    // 4. HÀM KHÓA / MỞ KHÓA
    window.toggleBan = async (uid, newStatus) => {
        const action = newStatus === 'banned' ? "KHÓA" : "MỞ KHÓA";
        if (!confirm(`Xác nhận ${action} học viên này?`)) return;
        const userRef = doc(db, "users", uid);
        await updateDoc(userRef, { status: newStatus });
        fetchUsers();
    };

    // Khởi chạy
    fetchUsers();

</script>
</body>
</html>
