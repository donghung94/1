<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ÄÄƒng nháº­p â€“ Toukutei Gino 2</title>
    <link rel="icon" href="icon-192.png" /> 
    <style>
        /* Reset cÆ¡ báº£n */
        * { box-sizing: border-box; }
        body {
            background: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
    </style>
</head>

<body>

    <div style="background:#fff;padding:26px 22px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,.12);text-align:center;width:320px;">
        <img src="icon-192.png" alt="Logo" style="width:80px;border-radius:12px;margin-bottom:10px;" />
        
        <h2 style="margin:6px 0 12px;font-size:18px; color: #333;">ğŸ”’ ÄÄƒng nháº­p Quiz App</h2>
        <p style="font-size: 13px; color: #666; margin-bottom: 20px;">Luyá»‡n thi Ká»¹ nÄƒng Ä‘áº·c Ä‘á»‹nh sá»‘ 2</p>

        <form id="loginForm">
            <input type="email" id="email" placeholder="Email" required
                style="width:100%;padding:12px 12px;margin:8px 0;border:1px solid #e5e7eb;border-radius:8px;outline:none; transition: 0.3s;" 
                onfocus="this.style.borderColor='#1e40af'" onblur="this.style.borderColor='#e5e7eb'" />
            
            <input type="password" id="password" placeholder="Máº­t kháº©u" required
                style="width:100%;padding:12px 12px;margin:8px 0;border:1px solid #e5e7eb;border-radius:8px;outline:none; transition: 0.3s;" 
                onfocus="this.style.borderColor='#1e40af'" onblur="this.style.borderColor='#e5e7eb'" />

            <button type="submit" id="loginBtn"
                style="background:#1e40af;color:#fff;border:none;padding:12px 15px;width:100%;border-radius:8px;cursor:pointer;font-weight:600;margin-top:10px; font-size: 15px;">
                ÄÄƒng nháº­p
            </button>
        </form>

        <p id="message" style="margin-top:12px;font-size:14px;min-height:18px; line-height: 1.4;"></p>

        <div style="margin-top:15px;font-size:12px;color:#6b7280; border-top: 1px solid #eee; padding-top: 10px;">
            LÆ°u Ã½: TÃ i khoáº£n chá»‰ sá»­ dá»¥ng tá»‘i Ä‘a <strong>02 thiáº¿t bá»‹</strong>.
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Cáº¤U HÃŒNH FIREBASE (âš ï¸ THAY Cá»¦A Báº N VÃ€O ÄÃ‚Y)
        const firebaseConfig = {
            apiKey: "AIzaSyALblbqW_VrZh2r7sPJ8Q6XT2fGbk0dsFg",
            authDomain: "donghung-3208d.firebaseapp.com",
            projectId: "donghung-3208d",
            storageBucket: "donghung-3208d.firebasestorage.app",
            messagingSenderId: "753379492663",
            appId: "1:753379492663:web:baff34f2c0bac00e02d0b2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function getDeviceId() {
            let deviceId = localStorage.getItem('my_device_id');
            if (!deviceId) {
                deviceId = 'dev_' + Math.random().toString(36).substr(2, 9) + '_' + window.screen.width;
                localStorage.setItem('my_device_id', deviceId);
            }
            return deviceId;
        }

        function getDeviceName() {
            const ua = navigator.userAgent;
            if (ua.includes("iPhone")) return "iPhone";
            if (ua.includes("iPad")) return "iPad";
            if (ua.includes("Android")) return "Android";
            if (ua.includes("Win")) return "Windows PC";
            if (ua.includes("Mac")) return "Macbook";
            return "Thiáº¿t bá»‹ khÃ¡c";
        }

        const emailEl = document.getElementById("email");
        const passEl  = document.getElementById("password");
        const btn      = document.getElementById("loginBtn");
        const msg      = document.getElementById("message");
        const loginForm = document.getElementById("loginForm");

        onAuthStateChanged(auth, (user) => {
             if (user) {
                msg.textContent = "ğŸ”„ Äang táº£i dá»¯ liá»‡u...";
                msg.style.color = "green";
                setTimeout(()=> location.href = "index.html", 500);
             }
        });

        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const email = emailEl.value.trim();
            const password = passEl.value.trim();
            const currentDeviceId = getDeviceId();
            const currentDeviceName = getDeviceName();

            msg.textContent = "â³ Äang kiá»ƒm tra...";
            msg.style.color = "#1e40af"; 
            btn.disabled = true;
            btn.textContent = "Äang xá»­ lÃ½...";

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userDocRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userDocRef);

                // --- Tá»° Äá»˜NG Táº O Há»’ SÆ  CHO USER CÅ¨ ---
                if (!userSnap.exists()) {
                    const initialData = {
                        name: user.displayName || "Há»c viÃªn",
                        email: user.email,
                        role: "student",
                        device_count: 1, 
                        devices: {
                            [currentDeviceId]: {
                                name: currentDeviceName,
                                addedAt: serverTimestamp(),
                                last_login: serverTimestamp()
                            }
                        },
                        status: "active",
                        createdAt: serverTimestamp()
                    };
                    await setDoc(userDocRef, initialData);
                } else {
                    // --- LOGIC KIá»‚M TRA CHO USER ÄÃƒ CÃ“ Há»’ SÆ  ---
                    const userData = userSnap.data();

                    if (userData.status === 'banned') {
                        await signOut(auth);
                        throw new Error("TÃ i khoáº£n Ä‘Ã£ bá»‹ khÃ³a.");
                    }

                    const devices = userData.devices || {};
                    const deviceCount = userData.device_count || 0;

                    if (devices[currentDeviceId]) {
                        await updateDoc(userDocRef, {
                            [`devices.${currentDeviceId}.last_login`]: serverTimestamp()
                        });
                    } else {
                        if (deviceCount >= 2) {
                            await signOut(auth);
                            throw new Error("ğŸš« ÄÃ£ Ä‘áº¡t giá»›i háº¡n 2 thiáº¿t bá»‹.");
                        } else {
                            await updateDoc(userDocRef, {
                                [`devices.${currentDeviceId}`]: {
                                    name: currentDeviceName,
                                    addedAt: serverTimestamp(),
                                    last_login: serverTimestamp()
                                },
                                device_count: deviceCount + 1
                            });
                        }
                    }
                }

                msg.textContent = "âœ… ThÃ nh cÃ´ng!";
                msg.style.color = "green";
                setTimeout(() => location.href = "index.html", 800);

            } catch (err) {
                let text = err.message;
                if (err.code === 'auth/invalid-credential') text = "Sai email hoáº·c máº­t kháº©u.";
                msg.textContent = "âŒ " + text;
                msg.style.color = "#ef4444";
                btn.disabled = false;
                btn.textContent = "ÄÄƒng nháº­p";
            }
        });
    </script>
</body>
</html>
