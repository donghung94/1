<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ÄÄƒng nháº­p â€“ Toukutei Gino 2</title>
    <link rel="icon" href="icon-192.png" /> 
    <style>
       body { margin: 0; background: #f8fafc; font-family: sans-serif; }
    .wrapper { max-width: 420px; margin: 20px auto; padding: 10px; }
    .warning-box { background: #fff3f3; border: 2px solid #ff4d4d; border-radius: 12px; padding: 15px; margin-bottom: 16px; text-align: center; }
    .warning-box h1 { color: #d90000; font-size: 18px; margin-bottom: 8px; }
    .warning-box p { font-size: 14px; line-height: 1.5; }
    .login-box { background: #fff; padding: 22px; border-radius: 12px; box-shadow: 0 10px 30px rgba(2,6,23,.12); text-align: center; }
    .login-box img { width: 80px; border-radius: 12px; margin-bottom: 10px; }
    .login-box input { width: 100%; padding: 10px 12px; margin: 8px 0; border: 1px solid #e5e7eb; border-radius: 8px; }
    .login-box button { width: 100%; padding: 10px; border: none; border-radius: 8px; background: #1e40af; color: #fff; font-weight: 600; margin-top: 8px; }
    .note { margin-top: 8px; font-size: 12px; color: #6b7280; }
    </style>
</head>

<body>
<div class="wrapper">
  <div class="warning-box">
    <h1>âš ï¸ Cáº¢NH BÃO Lá»ªA Äáº¢O</h1>
    <p>Hiá»‡n táº¡i cÃ³ <a href="https://www.tiktok.com/@tokutegino2xaydung" target="_blank">Link TikTok giáº£</a> lá»«a Ä‘áº£o bÃ¡n app.</p>
    <p>ğŸ‘‰ <b>LÆ°u Ã½:</b> KHÃ”NG chuyá»ƒn tiá»n trÆ°á»›c â€“ KHÃ”NG bÃ¡n app trÃ´i ná»•i.</p>
    <p>ğŸ“© Há»c viÃªn má»›i vui lÃ²ng IB <a href="https://www.tiktok.com/@anhphuong19912" target="_blank">TikTok CHÃNH CHá»¦</a> Ä‘á»ƒ Ä‘Æ°á»£c cáº¥p app.</p>
    <p><b>â— CÃ¡c nick khÃ¡c Ä‘á»u lÃ  giáº£ máº¡o</b></p>
  </div>
    <div class="login-box">
    <img src="icon-192.png" alt="Logo" />
        <h2 style="margin:6px 0 12px;font-size:18px; color: #333;">ğŸ”’ ÄÄƒng nháº­p Quiz App</h2>
        <p style="font-size: 13px; color: #666; margin-bottom: 20px;">Luyá»‡n thi Ká»¹ nÄƒng Ä‘áº·c Ä‘á»‹nh sá»‘ 2</p>

        <form id="loginForm">
            <input type="email" id="email" placeholder="Email" required
                style="width:100%;padding:12px 12px;margin:8px 0;border:1px solid #e5e7eb;border-radius:8px;outline:none;" />
            
            <input type="password" id="password" placeholder="Máº­t kháº©u" required
                style="width:100%;padding:12px 12px;margin:8px 0;border:1px solid #e5e7eb;border-radius:8px;outline:none;" />

            <button type="submit" id="loginBtn">ÄÄƒng nháº­p</button>
        </form>

        <p id="message" style="margin-top:12px;font-size:14px;min-height:18px; line-height: 1.4;"></p>

        <div style="margin-top:15px;font-size:12px;color:#6b7280; border-top: 1px solid #eee; padding-top: 10px;">
            LÆ°u Ã½: TÃ i khoáº£n chá»‰ sá»­ dá»¥ng tá»‘i Ä‘a <strong>01 thiáº¿t bá»‹</strong>.
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALblbqW_VrZh2r7sPJ8Q6XT2fGbk0dsFg",
            authDomain: "donghung-3208d.firebaseapp.com",
            projectId: "donghung-3208d",
            storageBucket: "donghung-3208d.firebasestorage.app",
            messagingSenderId: "753379492663",
            appId: "1:753379492663:web:baff34f2c0bac00e02d0b2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Cá»‘ Ä‘á»‹nh ID thiáº¿t bá»‹ báº±ng LocalStorage ---
        function getDeviceId() {
            let deviceId = localStorage.getItem('my_device_id');
            if (!deviceId) {
                // Sá»­ dá»¥ng timestamp + chuá»—i ngáº«u nhiÃªn Ä‘á»ƒ ID khÃ´ng bá»‹ trÃ¹ng
                deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                localStorage.setItem('my_device_id', deviceId);
            }
            return deviceId;
        }

        function getDeviceName() {
            const ua = navigator.userAgent;
            if (ua.includes("iPhone")) return "iPhone";
            if (ua.includes("Android")) return "Android";
            if (ua.includes("Win")) return "Windows PC";
            return "Mobile/Tablet";
        }

        const emailEl = document.getElementById("email");
        const passEl  = document.getElementById("password");
        const btn      = document.getElementById("loginBtn");
        const msg      = document.getElementById("message");
        const loginForm = document.getElementById("loginForm");

        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = emailEl.value.trim();
            const password = passEl.value.trim();
            const currentDeviceId = getDeviceId();
            const currentDeviceName = getDeviceName();

            msg.textContent = "â³ Äang kiá»ƒm tra...";
            msg.style.color = "#1e40af"; 
            btn.disabled = true;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userDocRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userDocRef);

                if (!userSnap.exists()) {
                    // TRÆ¯á»œNG Há»¢P 1: TÃ€I KHOáº¢N Má»šI TINH (ChÆ°a cÃ³ trong Firestore)
                    const initialData = {
                        name: user.displayName || "Há»c viÃªn",
                        email: user.email,
                        device_count: 1, // Ghi nháº­n 1 mÃ¡y ngay
                        devices: {
                            [currentDeviceId]: {
                                name: currentDeviceName,
                                addedAt: serverTimestamp(),
                                last_login: serverTimestamp()
                            }
                        },
                        status: "active",
                        createdAt: serverTimestamp()
                    };
                    await setDoc(userDocRef, initialData);
                } else {
                    // TRÆ¯á»œNG Há»¢P 2: ÄÃƒ CÃ“ Há»’ SÆ 
                    const userData = userSnap.data();
                    if (userData.status === 'banned') {
                        await signOut(auth);
                        throw new Error("TÃ i khoáº£n Ä‘Ã£ bá»‹ khÃ³a.");
                    }

                    const devices = userData.devices || {};
                    const deviceCount = userData.device_count || 0;

                    if (devices[currentDeviceId]) {
                        // A. Náº¿u lÃ  mÃ¡y cÅ© -> Cáº­p nháº­t giá» Ä‘Äƒng nháº­p
                        await updateDoc(userDocRef, {
                            [`devices.${currentDeviceId}.last_login`]: serverTimestamp()
                        });
                    } else {
                        // B. Náº¿u lÃ  mÃ¡y má»›i hoÃ n toÃ n
                        if (deviceCount >= 1) { 
                            // Cháº·n ngay vÃ¬ Ä‘Ã£ Ä‘á»§ 1 mÃ¡y
                            await signOut(auth);
                            throw new Error("ğŸš« TÃ i khoáº£n chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng trÃªn 1 thiáº¿t bá»‹. Vui lÃ²ng liÃªn há»‡ Admin Ä‘á»ƒ Reset.");
                        } else {
                            // ChÆ°a cÃ³ mÃ¡y nÃ o (do admin reset) -> Cho phÃ©p Ä‘Äƒng kÃ½ mÃ¡y nÃ y
                            await updateDoc(userDocRef, {
                                [`devices.${currentDeviceId}`]: {
                                    name: currentDeviceName,
                                    addedAt: serverTimestamp(),
                                    last_login: serverTimestamp()
                                },
                                device_count: 1 // Ghi Ä‘Ã¨ thÃ nh 1
                            });
                        }
                    }
                }

                msg.textContent = "âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!";
                msg.style.color = "green";
                setTimeout(() => location.href = "index.html", 500);

            } catch (err) {
                let text = err.message;
                if (err.code === 'auth/invalid-credential') text = "Sai email hoáº·c máº­t kháº©u.";
                msg.textContent = "âŒ " + text;
                msg.style.color = "#ef4444";
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
